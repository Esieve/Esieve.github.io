<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Esieve&#39;s blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2019-12-07T15:34:14.057Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Esieve</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>mysql连接错误排查</title>
    <link href="http://yoursite.com/2018/12/07/mysql%E8%BF%9E%E6%8E%A5%E9%94%99%E8%AF%AF%E6%8E%92%E6%9F%A5/"/>
    <id>http://yoursite.com/2018/12/07/mysql连接错误排查/</id>
    <published>2018-12-07T15:09:00.000Z</published>
    <updated>2019-12-07T15:34:14.057Z</updated>
    
    <content type="html"><![CDATA[<p>最近一周，MiotDungBeetleManager和MiotSpecManager偶尔发生数据库连接错误的异常。</p><p>最终得出的结论是：由于我们的DAL层使用了数据库连接池&amp;&amp;我们的业务请求量比较低，导致连接池里的连接与数据库长时间没有通信，连接被数据库关掉了（mysql默认是8小时，连接不通信会被关掉）。但是被关掉的连接没有从连接池里踢掉，这些被关闭的连接与mysql通信时，发生了异常。</p><p>以下是排查过程：</p><p>现象：<br><img src="https://i.loli.net/2019/12/07/qmrt5PoeisJ7EOz.png" alt="image.png"></p><p>找原因：</p><p>1、 查看官方解释</p><blockquote><p>CommunicationsException源码中的解释<br>/**</p><ul><li>An exception to represent communications errors with the database.</li><li></li><li>Attempts to provide ‘friendler’ error messages to end-users, including last time a packet was sent to the database, what the client-timeout is set to, and</li><li>whether the idle time has been exceeded.</li><li>/<br>即是客户端与数据库通信时发发生了错误时抛出该异常。以上这个注释没有明确解释产生该异常的原因。同时官方网站也没有查到相关信息。<br>(异常日志中有以下一段，它表明客户端与数据库通信是OK的。)<br>The last packet successfully received from the server was 2,016 milliseconds ago.  The last packet sent successfully to the server was 2,009 milliseconds ago</li></ul></blockquote><p>2、 Google</p><blockquote><p>大部分的信息都是说发生这个错误一般是由于客户端使的数据库连接由于与数据库长时间没有通信，连接被数据库关闭了。<br>客户端拿着一个实际已被关闭的连接与数据库通信时，会发生CommunicationsException(也许也有其它可能)。以下我们尝试以这个说法来找原因。</p></blockquote><p>讨论以上说法的可能性：<br>MI_DAL的数据库连接池是基于apache GenericObjectPool的封装，查看代码，连接池涉及以下几个重要参数</p><table><thead><tr><th>参数名</th><th>意义</th><th>我们系统的值</th><th>是否能设置</th></tr></thead><tbody><tr><td>testWhileIdle</td><td>是否测试处于idle状态的连接是否还有效</td><td>true</td><td>N</td></tr><tr><td>maxActive</td><td>最大活跃连接数。如果当前活跃连接数已达上限，客户端再尝试从从连接池中取连接时，会抛出异常</td><td>50</td><td>Y</td></tr><tr><td>maxIdle</td><td>允许处于idle状态的最大连接数。当客户端处理完逻辑，往连接池归还连接时，如果连接池中的idle连接已达该值，则该连接会会被直接关闭。</td><td>5</td><td>Y</td></tr><tr><td>numTestsPerEvictionRun</td><td>连接池有一个后台Eviction Timer，定期检查idle状态的连接，如果检测出连接实际上已无效(已被关闭)，则会将该连接踢出连接池。该参数设置的是Timer线程每次执行时，最多能检测几个连接(即并不是是每次运行都把连接池里面的连接都检查一遍)。</td><td>3</td><td>N</td></tr><tr><td>minEvictableIdleTimeMill</td><td>一个连接被归还给连接池多长时间之后，才会被认为处于idle状态&amp;&amp;能够被Eviction Timer检测并踢出连接连接池</td><td>10分钟</td><td>N</td></tr><tr><td>timeBetweenEvictionRunsMillis</td><td>Eviction Timer的运行频率</td><td>12分钟</td><td>N</td></tr><tr><td>testOnBorrow</td><td>是否在每次从连接池里取出连接后都检测连接是否有效。设置为true对性能有一定影响。</td><td>false</td><td>N</td></tr></tbody></table><p>(以上否能设置一列表示Mi_DAL是否有提供入口让我们设置该值)</p><p>要彻底解决从连接池中取到无效连接导致SQL执行失败的问题，需要将testOnBorrow设置为true。但是MI_DAL没有提供设置该参数的入口。</p><p>能够设置的参数只有maxIdle。</p><p>以上参数可能造成的问题：</p><p><code>axIdle(5)&gt; numTestsPerEvictionRun(3)：</code></p><p>假设连接池中现在有5个连接，状态全部是idle。接着，Eviction Timer运行了一次，清理了其中3个(numTestsPerEvictionRun)。接着，来了一个SQL，直接从连接池中取了连接，这个连接实际上可能已经被数据库端关闭了，于是，就发生了以上的异常。</p><p>合理的设置，应该是将numTestsPerEvictionRun设置成&gt;= maxIdle,即每次运行Eviction Timer都可以将所有的idle连接清理出连接池。</p><p>由于numTestsPerEvictionRun不能设置，只能将maxIdle调小为3,以覆盖掉默认值，设置方法</p><p><code>sql.socket.connect.max.idle=3</code></p><p>初步结论：</p><ol><li>通过在JVM的启动参数中设置以下参数，可以降低出异常的可能（或者修改DAL代码，将以上几个参数暴露出来给我设置）<br><code>-Dsql.socket.connect.max.idle=3</code></li><li>Eviction Timer的运行频率是12分钟，在这12分钟内，如果有SQL拿到了实际已被关闭的连接，仍然会发生异常</li><li>只有将testOnBorrow设置为true,才能根绝这个问题</li><li>这个问题发生的概率很低，对线上造成的影响几乎可以忽略</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;最近一周，MiotDungBeetleManager和MiotSpecManager偶尔发生数据库连接错误的异常。&lt;/p&gt;
&lt;p&gt;最终得出的结论是：由于我们的DAL层使用了数据库连接池&amp;amp;&amp;amp;我们的业务请求量比较低，导致连接池里的连接与数据库长时间没有通信，连接
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>onos动态扩容实战与源码分析</title>
    <link href="http://yoursite.com/2018/09/26/onos%E5%8A%A8%E6%80%81%E6%89%A9%E5%AE%B9%E5%AE%9E%E6%88%98%E4%B8%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>http://yoursite.com/2018/09/26/onos动态扩容实战与源码分析/</id>
    <published>2018-09-26T13:13:00.000Z</published>
    <updated>2019-12-07T13:45:38.376Z</updated>
    
    <content type="html"><![CDATA[<p>目前onos的扩容做的还不是很完善，比如onos源码提供了client添加controller的命令实现文件，在”onos/cli/src/main/java/org/onosproject/cli/NodeAddCommand.java”</p><pre><code class="java"><span class="comment">/*</span><span class="comment"> * Copyright 2014-present Open Networking Laboratory</span><span class="comment"> *</span><span class="comment"> * Licensed under the Apache License, Version 2.0 (the "License");</span><span class="comment"> * you may not use this file except in compliance with the License.</span><span class="comment"> * You may obtain a copy of the License at</span><span class="comment"> *</span><span class="comment"> *     http://www.apache.org/licenses/LICENSE-2.0</span><span class="comment"> *</span><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span><span class="comment"> * distributed under the License is distributed on an "AS IS" BASIS,</span><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><span class="comment"> * See the License for the specific language governing permissions and</span><span class="comment"> * limitations under the License.</span><span class="comment"> */</span><span class="keyword">package</span> org.onosproject.cli;<span class="keyword">import</span> org.apache.karaf.shell.commands.Argument;<span class="keyword">import</span> org.apache.karaf.shell.commands.Command;<span class="keyword">import</span> org.onosproject.cluster.ClusterAdminService;<span class="keyword">import</span> org.onosproject.cluster.DefaultControllerNode;<span class="keyword">import</span> org.onosproject.cluster.NodeId;<span class="keyword">import</span> org.onlab.packet.IpAddress;<span class="comment">/**</span><span class="comment"> * Adds a new controller cluster node.</span><span class="comment"> */</span><span class="meta">@Command</span>(scope = <span class="string">"onos"</span>, name = <span class="string">"add-node"</span>,         description = <span class="string">"Adds a new controller cluster node"</span>)<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NodeAddCommand</span> <span class="keyword">extends</span> <span class="title">AbstractShellCommand</span> </span>{    <span class="meta">@Argument</span>(index = <span class="number">0</span>, name = <span class="string">"nodeId"</span>, description = <span class="string">"Node ID"</span>,              required = <span class="keyword">true</span>, multiValued = <span class="keyword">false</span>)    String nodeId = <span class="keyword">null</span>;    <span class="meta">@Argument</span>(index = <span class="number">1</span>, name = <span class="string">"ip"</span>, description = <span class="string">"Node IP address"</span>,              required = <span class="keyword">true</span>, multiValued = <span class="keyword">false</span>)    String ip = <span class="keyword">null</span>;    <span class="meta">@Argument</span>(index = <span class="number">2</span>, name = <span class="string">"tcpPort"</span>, description = <span class="string">"Node TCP listen port"</span>,              required = <span class="keyword">false</span>, multiValued = <span class="keyword">false</span>)    <span class="keyword">int</span> tcpPort = DefaultControllerNode.DEFAULT_PORT;    <span class="meta">@Override</span>    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>{        ClusterAdminService service = get(ClusterAdminService<span class="class">.<span class="keyword">class</span>)</span>;        service.addNode(<span class="keyword">new</span> NodeId(nodeId), IpAddress.valueOf(ip), tcpPort);    }} </code></pre><p>然而在客户端中是没有这个命令的，也就是他还没有完全实现，所以只能期待后续的完善。</p><p>我们可以在启动onos的时候通过onos-form-cluster命令直接启动一个集群，这个脚本文件的源码如下：</p><pre><code class="bash"><span class="meta">#!/bin/bash</span><span class="comment"># -----------------------------------------------------------------------------</span><span class="comment"># Forms ONOS cluster using REST API of each separate instance.</span><span class="comment"># -----------------------------------------------------------------------------</span>[ <span class="variable">$#</span> -lt 2 ] &amp;&amp; <span class="built_in">echo</span> <span class="string">"usage: <span class="variable">$(basename $0)</span> ip1 ip2..."</span> &amp;&amp; <span class="built_in">exit</span> 1<span class="comment"># Scan arguments for user/password or other options...</span><span class="keyword">while</span> <span class="built_in">getopts</span> u:p:s: o; <span class="keyword">do</span>    <span class="keyword">case</span> <span class="string">"<span class="variable">$o</span>"</span> <span class="keyword">in</span>        u) user=<span class="variable">$OPTARG</span>;;        p) password=<span class="variable">$OPTARG</span>;;        s) partitionsize=<span class="variable">$OPTARG</span>;;    <span class="keyword">esac</span><span class="keyword">done</span>ONOS_WEB_USER=<span class="variable">${ONOS_WEB_USER:-onos}</span> <span class="comment"># ONOS WEB User defaults to 'onos'</span>ONOS_WEB_PASS=<span class="variable">${ONOS_WEB_PASS:-rocks}</span> <span class="comment"># ONOS WEB Password defaults to 'rocks'</span>user=<span class="variable">${user:-$ONOS_WEB_USER}</span>password=<span class="variable">${password:-$ONOS_WEB_PASS}</span><span class="built_in">let</span> OPC=<span class="variable">$OPTIND</span>-1<span class="built_in">shift</span> <span class="variable">$OPC</span>ip=<span class="variable">$1</span><span class="built_in">shift</span>nodes=$*ipPrefix=<span class="variable">${ip%.*}</span>aux=/tmp/<span class="variable">${ipPrefix}</span>.cluster.json<span class="built_in">trap</span> <span class="string">"rm -f <span class="variable">$aux</span>"</span> EXIT<span class="built_in">echo</span> <span class="string">"{ \"nodes\": [ { \"ip\": \"<span class="variable">$ip</span>\" }"</span> &gt; <span class="variable">$aux</span><span class="keyword">for</span> node <span class="keyword">in</span> <span class="variable">$nodes</span>; <span class="keyword">do</span>    <span class="built_in">echo</span> <span class="string">", { \"ip\": \"<span class="variable">$node</span>\" }"</span> &gt;&gt; <span class="variable">$aux</span><span class="keyword">done</span><span class="built_in">echo</span> <span class="string">"], \"ipPrefix\": \"<span class="variable">$ipPrefix</span>.*\""</span> &gt;&gt; <span class="variable">$aux</span><span class="keyword">if</span> ! [ -z <span class="variable">${partitionsize}</span> ]; <span class="keyword">then</span>    <span class="built_in">echo</span> <span class="string">", \"partitionSize\": <span class="variable">$partitionsize</span>"</span> &gt;&gt; <span class="variable">$aux</span><span class="keyword">fi</span><span class="built_in">echo</span> <span class="string">" }"</span> &gt;&gt; <span class="variable">$aux</span><span class="keyword">for</span> node <span class="keyword">in</span> <span class="variable">$ip</span> <span class="variable">$nodes</span>; <span class="keyword">do</span>    <span class="built_in">echo</span> <span class="string">"Forming cluster on <span class="variable">$node</span>..."</span>    curl --user <span class="variable">$user</span>:<span class="variable">$password</span> -X POST \        http://<span class="variable">$node</span>:8181/onos/v1/cluster/configuration -d @<span class="variable">$aux</span><span class="keyword">done</span> </code></pre><p>我们只需要关注最后的实现，其实它只是向每个节点的一个HTTP API接口发送post请求，提交一个配置文件，这个API的实现在这里onos\web\api\src\main\java\org\onosproject\rest\resources\ClusterWebResource.java：</p><pre><code class="java">    <span class="comment">/**</span><span class="comment">     * Forms cluster of ONOS instances.</span><span class="comment">     * Forms ONOS cluster using the uploaded JSON definition.</span><span class="comment">     *</span><span class="comment">     * <span class="doctag">@param</span> config cluster definition</span><span class="comment">     * <span class="doctag">@return</span> 200 OK</span><span class="comment">     * <span class="doctag">@throws</span> IOException to signify bad request</span><span class="comment">     * <span class="doctag">@onos</span>.rsModel ClusterPost</span><span class="comment">     */</span>    <span class="meta">@POST</span>    <span class="meta">@Path</span>(<span class="string">"configuration"</span>)    <span class="meta">@Produces</span>(MediaType.APPLICATION_JSON)    <span class="function"><span class="keyword">public</span> Response <span class="title">formCluster</span><span class="params">(InputStream config)</span> <span class="keyword">throws</span> IOException </span>{        JsonCodec&lt;ControllerNode&gt; codec = codec(ControllerNode<span class="class">.<span class="keyword">class</span>)</span>;        ObjectNode root = (ObjectNode) mapper().readTree(config);        List&lt;ControllerNode&gt; nodes = codec.decode((ArrayNode) root.path(<span class="string">"nodes"</span>), <span class="keyword">this</span>);        JsonNode partitionSizeNode = root.get(<span class="string">"partitionSize"</span>);        <span class="keyword">if</span> (partitionSizeNode != <span class="keyword">null</span>) {            <span class="keyword">int</span> partitionSize = partitionSizeNode.asInt();            <span class="keyword">if</span> (partitionSize == <span class="number">0</span>) {                <span class="keyword">return</span> Response.notAcceptable(<span class="keyword">null</span>).build();            }            get(ClusterAdminService<span class="class">.<span class="keyword">class</span>).<span class="title">formCluster</span>(<span class="title">new</span> <span class="title">HashSet</span>&lt;&gt;(<span class="title">nodes</span>), <span class="title">partitionSize</span>)</span>;        } <span class="keyword">else</span> {            get(ClusterAdminService<span class="class">.<span class="keyword">class</span>).<span class="title">formCluster</span>(<span class="title">new</span> <span class="title">HashSet</span>&lt;&gt;(<span class="title">nodes</span>))</span>;        }        <span class="keyword">return</span> Response.ok().build();    }}</code></pre><p> 在formCluster方法中，首先它会解析Json格式的配置文件，然后进一步调用方法，实现在onos\core\net\src\main\java\org\onosproject\cluster\impl\ClusterManager.java</p><pre><code class="java"><span class="meta">@Override</span><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">formCluster</span><span class="params">(Set&lt;ControllerNode&gt; nodes, <span class="keyword">int</span> partitionSize)</span> </span>{    checkNotNull(nodes, <span class="string">"Nodes cannot be null"</span>);    checkArgument(!nodes.isEmpty(), <span class="string">"Nodes cannot be empty"</span>);    ClusterMetadata metadata = <span class="keyword">new</span> ClusterMetadata(<span class="string">"default"</span>, nodes, buildDefaultPartitions(nodes, partitionSize));    clusterMetadataAdminService.setClusterMetadata(metadata);    <span class="keyword">try</span> {        log.warn(<span class="string">"Shutting down container for cluster reconfiguration!"</span>);        <span class="comment">// Clean up persistent state associated with previous cluster configuration.</span>        Tools.removeDirectory(System.getProperty(<span class="string">"karaf.data"</span>) + <span class="string">"/partitions"</span>);        systemService.reboot(<span class="string">"now"</span>, SystemService.Swipe.NONE);    } <span class="keyword">catch</span> (Exception e) {        log.error(<span class="string">"Unable to reboot container"</span>, e);    }}</code></pre><p>它会更新ClusterMetadata，然后删除apache…/data/partitions目录，最后重启karaf<br>在onos\core\net\src\main\java\org\onosproject\cluster\impl\ClusterMetadataManager.java里，有一个方法：</p><pre><code class="java"><span class="comment">/**</span><span class="comment"> * Returns the primary provider for cluster metadata.</span><span class="comment"> * <span class="doctag">@return</span> primary cluster metadata provider</span><span class="comment"> */</span><span class="comment">//default scheme is file</span><span class="function"><span class="keyword">private</span> ClusterMetadataProvider <span class="title">getPrimaryProvider</span><span class="params">()</span> </span>{    String metadataUri = System.getProperty(<span class="string">"onos.cluster.metadata.uri"</span>);    <span class="keyword">try</span> {        String protocol = metadataUri == <span class="keyword">null</span> ? <span class="keyword">null</span> : <span class="keyword">new</span> URL(metadataUri).getProtocol();        <span class="keyword">if</span> (protocol != <span class="keyword">null</span> &amp;&amp; (!protocol.equals(<span class="string">"file"</span>) &amp;&amp; !protocol.equals(<span class="string">"http"</span>))) {            <span class="keyword">return</span> getProvider(protocol);        }        <span class="comment">// file provider supports both "file" and "http" uris</span>        <span class="keyword">return</span> getProvider(<span class="string">"file"</span>);    } <span class="keyword">catch</span> (MalformedURLException e) {        <span class="keyword">return</span> <span class="keyword">null</span>;    }}</code></pre><p> 这个方法会获取”onos.cluster.metadata.uri”属性，判断是file还是http，默认情况下是file，指向安装目录下config/cluster.json文件，也就是说，onos关于集群的管理是基于这个配置文件，我们可以从onos\core\net\src\main\java\org\onosproject\cluster\impl\ConfigFileBasedClusterMetadataProvider.java中看出，onos会不断扫描这个文件，更新我们的配置，如果我们把”onos.cluster.metadata.uri”指向一个可以访问到的url，onos就会开启一个输入流不断读取。所以一个比较好的方法是，在一台机器上开启一个server服务，让其它onos集群都来访问这个api，否则只能一个个手动更换每台机器的配置文件。</p><p>与onos集群相关的代码还有onos\core\store\primitives\src\main\java\org\onosproject\store\primitives\impl\PartitionManager、onos\core\store\primitives\src\main\java\org\onosproject\store\primitives\impl\StorageManager、onos\core\api\src\main\java\org\onosproject\cluster\ClusterMetadataDiff.java等</p><p>onos目前还不支持partition扩容，所以partition是不能修改的，只能增加每个partition的member数，看到官方开发人员说有可能会在1.12版本上这个功能。。</p><p>这里我们以3台扩5台为例</p><p>1、首先要修改每台机器的”onos.cluster.metadata.uri”，只需在bin目录下onos-service添加下面加粗的一行就好</p><pre><code class="bash"><span class="meta">#!/bin/bash</span><span class="comment"># -----------------------------------------------------------------------------</span><span class="comment"># Starts ONOS Apache Karaf container</span><span class="comment"># -----------------------------------------------------------------------------</span><span class="comment"># uncomment the following line for performance testing</span><span class="comment">#export JAVA_OPTS="${JAVA_OPTS:--Xms8G -Xmx8G -XX:+UseConcMarkSweepGC -XX:+CMSIncrementalMode -XX:+PrintGCDetails -XX:+PrintGCTimeStamps}"</span><span class="comment"># uncomment the following line for Netty TLS encryption</span><span class="comment"># Do modify the keystore location/password and truststore location/password accordingly</span><span class="comment">#export JAVA_OPTS="${JAVA_OPTS:--DenableNettyTLS=true -Djavax.net.ssl.keyStore=/home/ubuntu/onos.jks -Djavax.net.ssl.keyStorePassword=222222 -Djavax.net.ssl.trustStore=/home/ubuntu/onos.jks -Djavax.net.ssl.trustStorePassword=222222}"</span><span class="built_in">export</span> JAVA_OPTS=<span class="variable">${JAVA_OPTS:--Donos.cluster.metadata.uri=http://10.97.25.221:5000/cluster.json}</span><span class="comment">#在这里，指向你的服务地址</span><span class="built_in">set</span> -e  <span class="comment"># exit on error</span><span class="built_in">set</span> -u  <span class="comment"># exit on undefined variable</span><span class="comment"># If ONOS_HOME is set, respect its value.</span><span class="comment"># If ONOS_HOME is not set (e.g. in the init or service environment),</span><span class="comment"># set it based on this script's path.</span>ONOS_HOME=<span class="variable">${ONOS_HOME:-$(cd $(dirname $0)/.. &gt;/dev/null 2&gt;&amp;1 &amp;&amp; pwd)}</span>KARAF_ARGS=SYS_APPS=driversONOS_APPS=<span class="variable">${ONOS_APPS:-}</span>  <span class="comment"># Empty means don't activate any new apps</span><span class="built_in">cd</span> <span class="variable">$ONOS_HOME</span><span class="comment"># Parse out arguments destinted for karaf invocation v. arguments that</span><span class="comment"># will be processed in line</span><span class="keyword">while</span> [ <span class="variable">$#</span> -gt 0 ]; <span class="keyword">do</span>  <span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span>    apps-clean)      <span class="comment"># Deactivate all applications</span>      find <span class="variable">${ONOS_HOME}</span>/apps -name <span class="string">"active"</span> -<span class="built_in">exec</span> rm \{\} \;      ;;    *)      KARAF_ARGS+=<span class="string">" <span class="variable">$1</span>"</span>      ;;  <span class="keyword">esac</span>  <span class="built_in">shift</span><span class="keyword">done</span><span class="comment"># Activate the system required applications (SYS_APPS) as well as any</span><span class="comment"># specified applications in the var ONOS_APPS</span><span class="keyword">for</span> app <span class="keyword">in</span> <span class="variable">${SYS_APPS//,/ }</span> <span class="variable">${ONOS_APPS//,/ }</span>; <span class="keyword">do</span>    <span class="keyword">if</span>  [ -d <span class="string">"<span class="variable">${ONOS_HOME}</span>/apps/org.onosproject.<span class="variable">$app</span>/"</span> ]; <span class="keyword">then</span>        touch <span class="variable">${ONOS_HOME}</span>/apps/org.onosproject.<span class="variable">$app</span>/active    <span class="keyword">elif</span> [ -d <span class="string">"<span class="variable">${ONOS_HOME}</span>/apps/<span class="variable">$app</span>"</span> ]; <span class="keyword">then</span>        touch <span class="variable">${ONOS_HOME}</span>/apps/<span class="variable">$app</span>/active    <span class="keyword">else</span>        <span class="built_in">echo</span> <span class="string">"[WARN] Don't know how to activate <span class="variable">$app</span>"</span>    <span class="keyword">fi</span><span class="keyword">done</span><span class="built_in">exec</span> <span class="variable">${ONOS_HOME}</span>/apache-karaf-3.0.8/bin/karaf <span class="variable">$KARAF_ARGS</span></code></pre><p>这样，onos启动后就会直接从这个地址获取配置文件</p><p>2、启动配置管理服务，这里我用python -m SimpleHTTPServer 5000起了个简单的server</p><p>3、修改cluster.json文件，三台时的配置文件如下</p><pre><code class="json">{  <span class="attr">"name"</span>: <span class="string">"default"</span>,  <span class="attr">"nodes"</span>: [    {      <span class="attr">"id"</span>: <span class="string">"172.17.0.7"</span>,      <span class="attr">"ip"</span>: <span class="string">"172.17.0.7"</span>,      <span class="attr">"port"</span>: <span class="number">9876</span>    },    {      <span class="attr">"id"</span>: <span class="string">"172.17.0.8"</span>,      <span class="attr">"ip"</span>: <span class="string">"172.17.0.8"</span>,      <span class="attr">"port"</span>: <span class="number">9876</span>    },    {      <span class="attr">"id"</span>: <span class="string">"172.17.0.9"</span>,      <span class="attr">"ip"</span>: <span class="string">"172.17.0.9"</span>,      <span class="attr">"port"</span>: <span class="number">9876</span>    }  ],  <span class="attr">"partitions"</span>: [    {      <span class="attr">"id"</span>: <span class="number">1</span>,      <span class="attr">"members"</span>: [        <span class="string">"172.17.0.7"</span>,        <span class="string">"172.17.0.8"</span>,        <span class="string">"172.17.0.9"</span>      ]    },    {      <span class="attr">"id"</span>: <span class="number">2</span>,      <span class="attr">"members"</span>: [        <span class="string">"172.17.0.9"</span>,        <span class="string">"172.17.0.7"</span>,        <span class="string">"172.17.0.8"</span>      ]    },    {      <span class="attr">"id"</span>: <span class="number">3</span>,      <span class="attr">"members"</span>: [        <span class="string">"172.17.0.8"</span>,        <span class="string">"172.17.0.9"</span>,        <span class="string">"172.17.0.7"</span>      ]    }  ]}由于partition不能扩充，所以升到5台的配置文件如下{  <span class="attr">"name"</span>: <span class="string">"default"</span>,  <span class="attr">"nodes"</span>: [    {      <span class="attr">"id"</span>: <span class="string">"172.17.0.7"</span>,      <span class="attr">"ip"</span>: <span class="string">"172.17.0.7"</span>,      <span class="attr">"port"</span>: <span class="number">9876</span>    },    {      <span class="attr">"id"</span>: <span class="string">"172.17.0.8"</span>,      <span class="attr">"ip"</span>: <span class="string">"172.17.0.8"</span>,      <span class="attr">"port"</span>: <span class="number">9876</span>    },    {      <span class="attr">"id"</span>: <span class="string">"172.17.0.9"</span>,      <span class="attr">"ip"</span>: <span class="string">"172.17.0.9"</span>,      <span class="attr">"port"</span>: <span class="number">9876</span>    },    {      <span class="attr">"id"</span>: <span class="string">"172.17.0.10"</span>,      <span class="attr">"ip"</span>: <span class="string">"172.17.0.10"</span>,      <span class="attr">"port"</span>: <span class="number">9876</span>    },    {      <span class="attr">"id"</span>: <span class="string">"172.17.0.11"</span>,      <span class="attr">"ip"</span>: <span class="string">"172.17.0.11"</span>,      <span class="attr">"port"</span>: <span class="number">9876</span>    }  ],  <span class="attr">"partitions"</span>: [    {      <span class="attr">"id"</span>: <span class="number">1</span>,      <span class="attr">"members"</span>: [        <span class="string">"172.17.0.7"</span>,        <span class="string">"172.17.0.8"</span>,        <span class="string">"172.17.0.9"</span>,        <span class="string">"172.17.0.10"</span>,        <span class="string">"172.17.0.11"</span>      ]    },    {      <span class="attr">"id"</span>: <span class="number">2</span>,      <span class="attr">"members"</span>: [        <span class="string">"172.17.0.11"</span>,        <span class="string">"172.17.0.7"</span>,        <span class="string">"172.17.0.8"</span>,        <span class="string">"172.17.0.9"</span>,        <span class="string">"172.17.0.10"</span>      ]    },    {      <span class="attr">"id"</span>: <span class="number">3</span>,      <span class="attr">"members"</span>: [        <span class="string">"172.17.0.10"</span>,        <span class="string">"172.17.0.11"</span>,        <span class="string">"172.17.0.7"</span>,        <span class="string">"172.17.0.8"</span>,        <span class="string">"172.17.0.9"</span>      ]    }  ]}</code></pre><p>4、最后启动我们要添加的两台onos机器，剩下的就会自动同步好 </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;目前onos的扩容做的还不是很完善，比如onos源码提供了client添加controller的命令实现文件，在”onos/cli/src/main/java/org/onosproject/cli/NodeAddCommand.java”&lt;/p&gt;
&lt;pre&gt;&lt;code c
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Raft协议为何只能有奇数个节点</title>
    <link href="http://yoursite.com/2018/09/07/Raft%E5%8D%8F%E8%AE%AE%E4%B8%BA%E4%BD%95%E5%8F%AA%E8%83%BD%E6%9C%89%E5%A5%87%E6%95%B0%E4%B8%AA%E8%8A%82%E7%82%B9/"/>
    <id>http://yoursite.com/2018/09/07/Raft协议为何只能有奇数个节点/</id>
    <published>2018-09-07T13:05:00.000Z</published>
    <updated>2019-12-07T13:12:39.630Z</updated>
    
    <content type="html"><![CDATA[<p>ONOS系统1.4版本以后使用Atomix作为分布式协调框架，因而使用RAFT协议保证一致性。其中有一个要求是集群中节点数必须为奇数个。查了一下没找到原因，思考了一下，想到了一点是这样可以解决split-brain问题。这样当网络故障发生时，无论集群怎么切分始终能保持有一半能获得多数确认，从而保证正常commit，待网络恢复后，再进行同步。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ONOS系统1.4版本以后使用Atomix作为分布式协调框架，因而使用RAFT协议保证一致性。其中有一个要求是集群中节点数必须为奇数个。查了一下没找到原因，思考了一下，想到了一点是这样可以解决split-brain问题。这样当网络故障发生时，无论集群怎么切分始终能保持有一半
      
    
    </summary>
    
    
      <category term="Distribute" scheme="http://yoursite.com/categories/Distribute/"/>
    
    
  </entry>
  
  <entry>
    <title>Go range函数踩坑</title>
    <link href="http://yoursite.com/2018/08/29/Go-range%E5%87%BD%E6%95%B0%E8%B8%A9%E5%9D%91/"/>
    <id>http://yoursite.com/2018/08/29/Go-range函数踩坑/</id>
    <published>2018-08-29T14:48:00.000Z</published>
    <updated>2019-12-07T14:49:42.316Z</updated>
    
    <content type="html"><![CDATA[<p>range函数返回的是变量的副本，而不是引用</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   a := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line">   a = <span class="built_in">append</span>(a, <span class="number">1</span>)</span><br><span class="line">   a = <span class="built_in">append</span>(a, <span class="number">1</span>)</span><br><span class="line">   a = <span class="built_in">append</span>(a, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">   fmt.Println(a)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> _, value := <span class="keyword">range</span> a &#123;</span><br><span class="line">      value = <span class="number">2</span></span><br><span class="line">      fmt.Println(value)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   fmt.Println(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> 这段代码slice a的值并不会真正修改，输出结果为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[1 1 1]</span><br><span class="line">2</span><br><span class="line">2</span><br><span class="line">2</span><br><span class="line">[1 1 1]</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;range函数返回的是变量的副本，而不是引用&lt;/p&gt;
&lt;figure class=&quot;highlight go&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;li
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>getContextPath、getServletPath、getRequestURI的区别</title>
    <link href="http://yoursite.com/2018/08/24/getContextPath%E3%80%81getServletPath%E3%80%81getRequestURI%E7%9A%84%E5%8C%BA%E5%88%AB/"/>
    <id>http://yoursite.com/2018/08/24/getContextPath、getServletPath、getRequestURI的区别/</id>
    <published>2018-08-24T14:51:00.000Z</published>
    <updated>2019-12-07T14:54:39.315Z</updated>
    
    <content type="html"><![CDATA[<p>假定你的web application 名称为news,你在浏览器中输入请求路径：<br><a href="http://localhost:8080/news/main/list.jsp" target="_blank" rel="noopener">http://localhost:8080/news/main/list.jsp</a><br>则执行下面向行代码后打印出如下结果： </p><ol><li>System.out.println(request.getContextPath()); //可返回站点的根路径。也就是项目的名字<br>打印结果：/news </li><li>System.out.println(request.getServletPath());<br>打印结果：/main/list.jsp </li><li>System.out.println(request.getRequestURI());<br>打印结果：/news/main/list.jsp </li><li>System.out.println(request.getRealPath(“/“));<br>打印结果：F:\Tomcat 6.0\webapps\news\test </li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;假定你的web application 名称为news,你在浏览器中输入请求路径：&lt;br&gt;&lt;a href=&quot;http://localhost:8080/news/main/list.jsp&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;http://loc
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>解决docker与主机时间不一致</title>
    <link href="http://yoursite.com/2018/06/07/%E8%A7%A3%E5%86%B3docker%E4%B8%8E%E4%B8%BB%E6%9C%BA%E6%97%B6%E9%97%B4%E4%B8%8D%E4%B8%80%E8%87%B4/"/>
    <id>http://yoursite.com/2018/06/07/解决docker与主机时间不一致/</id>
    <published>2018-06-07T15:03:00.000Z</published>
    <updated>2019-12-07T15:07:37.713Z</updated>
    
    <content type="html"><![CDATA[<p>1、共享主机时间</p><p>创建容器的时候指定启动参数，挂载localtime文件到容器内  ，保证两者所采用的时区是一致的。</p><p>```<br>docker run –name <name> -v /etc/localtime:/etc/localtime:ro ….<br>2、复制主机时间</p><p>docker cp /etc/localtime:【容器ID或者NAME0】/etc/localtime<br>3、Dockerfile中自定义</p><p>FROM redis</p><p>FROM tomcat</p><p>ENV CATALINA_HOME /usr/local/tomcat</p><p>#设置时区<br>RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime <br>  &amp;&amp; echo ‘Asia/Shanghai’ &gt;/etc/timezone \</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;1、共享主机时间&lt;/p&gt;
&lt;p&gt;创建容器的时候指定启动参数，挂载localtime文件到容器内  ，保证两者所采用的时区是一致的。&lt;/p&gt;
&lt;p&gt;```&lt;br&gt;docker run –name &lt;name&gt; -v /etc/localtime:/etc/localtime:
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://yoursite.com/2018/04/21/hello-world/"/>
    <id>http://yoursite.com/2018/04/21/hello-world/</id>
    <published>2018-04-21T12:46:00.000Z</published>
    <updated>2019-12-07T15:03:15.088Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
      
    
    </summary>
    
    
      <category term="Other" scheme="http://yoursite.com/categories/Other/"/>
    
    
  </entry>
  
</feed>
